---
title: "R Notebook"
output: html_notebook
---



```{r}
Daticatt <- read.csv("Data/nuovifile/Dati-catture.csv", dec=",", sep=";", header = TRUE)
Datioccas <- read.csv("Data/nuovifile/Dati-occasioni.csv", dec=",", sep=";", header = TRUE)
```

```{r}
create_detection_matrix <- function(anno, sessione) {
    # Seleziona l'anno e la sessione dai file di occasioni e catture
    print(paste0(anno, " - ",sessione))
    Datioccas_ <- Datioccas[Datioccas$Anno == anno & Datioccas$sessione == sessione ,]
    Daticatt_ <- Daticatt[Daticatt$Anno == anno & Daticatt$sessione == sessione ,]
    if (nrow(Datioccas_) == 0 | nrow(Daticatt_) == 0) {
        print("Dati non disponibili.")
        return(NULL)
    }
    
    # Crea un dataframe vuoto in cui inserire la relazione tra occasioni e trappole
    print(max(Datioccas_$occasione))
    occupancy_ncols <- max(Datioccas_$occasione) + 1
    #occupancy_nrows <- max(Datioccas_$trappole.posizionate)
    #occupancy_nrows <- nrow(1:75)
    m <- matrix(0, ncol = occupancy_ncols, nrow = 75)
    occupancy_occasioni <- data.frame(m)
    
    # Da un nome ad ogni variabile occasione ed aggiunge la variabile ID_TRAP
    colnames(occupancy_occasioni) <- c("ID_TRAP",paste0("occ ", 1:max(Datioccas_$occasione)))
    occupancy_occasioni$ID_TRAP <- seq.int(nrow(occupancy_occasioni))
    
    # Riempi la matrice con i valori dicotomici (1 indica almeno una cattura, 0 indica l'assenza di catture)
    for (cattura in c(1:nrow(Daticatt_))) {
        trappola <- as.numeric(as.character(Daticatt_[cattura,]$ID_TRAPPOLA))
        occasione <- Daticatt_[cattura,]$occasione
        
        occupancy_occasioni[trappola, paste0("occ ", occasione)] <- 1
    }
    result <- occupancy_occasioni
}
```

```{r}
for (anno in unique(Daticatt$Anno)) {
    dati_anno <- Daticatt[Daticatt$Anno == anno,]
    for (sessione in unique(dati_anno$sessione)) {
        matrice_detection <- NULL
        matrice_detection <- create_detection_matrix(anno, sessione)
        if (!is.null(matrice_detection)) {
            write.csv2(matrice_detection, paste0(file="/nuovifile/detection/Detection-Anno_",anno,"_Sessione_",sessione,".csv"), row.names = FALSE)
        }
    }
}

```

